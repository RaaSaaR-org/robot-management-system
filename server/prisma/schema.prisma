// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  // PostgreSQL for production/Kubernetes deployments
  // For local SQLite: provider = "sqlite", DATABASE_URL = "file:./dev.db"
  // For PostgreSQL:   provider = "postgresql", DATABASE_URL = "postgresql://user:pass@host:5432/db"
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ROBOT ENTITIES
// ============================================================================

model Robot {
  id              String   @id @default(uuid())
  name            String
  model           String
  serialNumber    String?  @unique
  status          String   @default("offline") // RobotStatus enum as string
  batteryLevel    Int      @default(100)
  location        String   @default("{}") // JSON: RobotLocation
  lastSeen        DateTime @default(now())
  currentTaskId   String?
  currentTaskName String?
  capabilities    String   @default("[]") // JSON: string[]
  firmware        String?
  ipAddress       String?
  metadata        String?  // JSON: Record<string, unknown>
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // A2A Integration
  a2aEnabled   Boolean @default(false)
  a2aAgentUrl  String?

  // Registration metadata
  registeredAt    DateTime?
  isConnected     Boolean   @default(false)
  lastHealthCheck DateTime?
  baseUrl         String?

  // Relations
  conversations Conversation[]
  telemetryLogs RobotTelemetry[]
  commands      RobotCommand[]
  agentCard     AgentCard?
  endpoints     RobotEndpoints?
  alerts        Alert[]
  robotTasks    RobotTask[]
  incidents     Incident[]

  @@index([status])
  @@index([a2aEnabled])
}

model RobotTelemetry {
  id                 String   @id @default(uuid())
  robotId            String
  batteryLevel       Int
  batteryVoltage     Float?
  batteryTemperature Float?
  cpuUsage           Float
  memoryUsage        Float
  diskUsage          Float?
  temperature        Float
  humidity           Float?
  speed              Float?
  sensors            String   @default("{}") // JSON: Record<string, number | boolean | string>
  errors             String   @default("[]") // JSON: string[]
  warnings           String   @default("[]") // JSON: string[]
  timestamp          DateTime @default(now())

  robot Robot @relation(fields: [robotId], references: [id], onDelete: Cascade)

  @@index([robotId, timestamp])
  @@index([timestamp])
}

model RobotCommand {
  id           String    @id @default(uuid())
  robotId      String
  type         String // CommandType enum as string
  payload      String    @default("{}") // JSON
  status       String    @default("pending") // CommandStatus enum as string
  priority     String    @default("normal") // CommandPriority enum as string
  result       String?   // JSON
  errorMessage String?
  createdAt    DateTime  @default(now())
  startedAt    DateTime?
  completedAt  DateTime?

  robot Robot @relation(fields: [robotId], references: [id], onDelete: Cascade)

  @@index([robotId, status])
  @@index([createdAt])
}

model RobotEndpoints {
  id          String   @id @default(uuid())
  robotId     String   @unique
  robot       String // endpoint path
  command     String // endpoint path
  telemetry   String // endpoint path
  telemetryWs String // WebSocket URL
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  robotRef Robot @relation(fields: [robotId], references: [id], onDelete: Cascade)
}

// ============================================================================
// A2A CONVERSATION ENTITIES
// ============================================================================

model Conversation {
  id        String    @id @default(uuid())
  name      String
  isActive  Boolean   @default(true)
  robotId   String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Soft delete support
  deletedAt DateTime?

  // Relations
  robot    Robot?    @relation(fields: [robotId], references: [id], onDelete: SetNull)
  messages Message[]
  tasks    Task[]

  @@index([robotId])
  @@index([isActive])
  @@index([updatedAt])
}

model Message {
  id             String   @id @default(uuid())
  role           String // MessageRole: 'user' | 'agent'
  parts          String // JSON: A2APart[]
  conversationId String?
  taskId         String?
  metadata       String?  // JSON: Record<string, unknown>
  timestamp      DateTime @default(now())

  // Relations
  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  task         Task?         @relation(fields: [taskId], references: [id], onDelete: SetNull)

  @@index([conversationId, timestamp])
  @@index([taskId])
}

model Task {
  id              String   @id @default(uuid())
  conversationId  String?
  state           String   @default("submitted") // TaskState enum as string
  statusMessage   String?  // JSON: A2AMessage
  statusTimestamp DateTime @default(now())
  artifacts       String   @default("[]") // JSON: A2AArtifact[]
  history         String   @default("[]") // JSON: A2AMessage[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  messages     Message[]

  @@index([conversationId])
  @@index([state])
  @@index([updatedAt])
}

// ============================================================================
// AGENT ENTITIES
// ============================================================================

model AgentCard {
  id                 String   @id @default(uuid())
  name               String   @unique
  description        String
  url                String
  version            String?
  documentationUrl   String?
  provider           String?  // JSON: { organization, url? }
  capabilities       String?  // JSON: { streaming?, pushNotifications?, stateTransitionHistory? }
  authentication     String?  // JSON: { schemes[], credentials? }
  defaultInputModes  String   @default("[]") // JSON: string[]
  defaultOutputModes String   @default("[]") // JSON: string[]
  skills             String   @default("[]") // JSON: A2ASkill[]
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Robot association (for robot agents)
  robotId String? @unique
  robot   Robot?  @relation(fields: [robotId], references: [id], onDelete: Cascade)

  @@index([name])
}

// ============================================================================
// ALERTS
// ============================================================================

model Alert {
  id             String    @id @default(uuid())
  severity       String // AlertSeverity: 'critical' | 'error' | 'warning' | 'info'
  title          String
  message        String
  source         String // AlertSource: 'robot' | 'task' | 'system' | 'user'
  sourceId       String? // ID of the source entity (robotId, taskId, etc.)
  acknowledged   Boolean   @default(false)
  acknowledgedAt DateTime?
  acknowledgedBy String? // User ID who acknowledged
  dismissable    Boolean   @default(true)
  autoDismissMs  Int? // Auto-dismiss after ms (null = never)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Optional relation to robot if source is robot
  robot Robot? @relation(fields: [sourceId], references: [id], onDelete: SetNull)

  @@index([severity])
  @@index([source])
  @@index([sourceId])
  @@index([acknowledged])
  @@index([createdAt])
}

// ============================================================================
// ZONES
// ============================================================================

model Zone {
  id          String   @id @default(uuid())
  name        String
  floor       String
  type        String // ZoneType: 'operational' | 'restricted' | 'charging' | 'maintenance'
  bounds      String // JSON: { x, y, width, height }
  color       String?
  description String?
  metadata    String? // JSON: Record<string, unknown>
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([name, floor])
  @@index([floor])
  @@index([type])
}

// ============================================================================
// EVENT LOG
// ============================================================================

model Event {
  id        String   @id @default(uuid())
  actor     String // 'user' | 'agent' | 'system'
  content   String // JSON: A2AMessage
  timestamp DateTime @default(now())

  @@index([timestamp])
  @@index([actor])
}

// ============================================================================
// USER AUTHENTICATION
// ============================================================================

model User {
  id                   String    @id @default(uuid())
  email                String    @unique
  passwordHash         String
  name                 String
  role                 String    @default("viewer") // UserRole: 'admin' | 'operator' | 'viewer'
  avatar               String?
  tenantId             String?
  isActive             Boolean   @default(true)
  passwordResetToken   String?
  passwordResetExpires DateTime?
  lastLoginAt          DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relations
  refreshTokens    RefreshToken[]
  gdprRequests     GDPRRequest[]
  consents         UserConsent[]
  dataRestrictions DataRestriction[]

  @@index([email])
  @@index([role])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([token])
}

// ============================================================================
// COMMAND INTERPRETATION
// ============================================================================

model CommandInterpretation {
  id                    String    @id @default(uuid())
  robotId               String
  originalText          String
  commandType           String // CommandType enum as string
  parameters            String    @default("{}") // JSON: CommandParameters
  confidence            Float
  safetyClassification  String // 'safe' | 'caution' | 'dangerous'
  warnings              String    @default("[]") // JSON: string[]
  suggestedAlternatives String    @default("[]") // JSON: string[]
  status                String    @default("interpreted") // CommandHistoryStatus
  executedCommandId     String? // Link to RobotCommand if executed
  createdAt             DateTime  @default(now())
  executedAt            DateTime?

  @@index([robotId])
  @@index([createdAt])
  @@index([status])
}

// ============================================================================
// PROCESS WORKFLOW MANAGEMENT
// ============================================================================

model ProcessDefinition {
  id                       String   @id @default(uuid())
  name                     String
  description              String?
  version                  Int      @default(1)
  status                   String   @default("draft") // ProcessDefinitionStatus: 'draft' | 'ready' | 'archived'
  stepTemplates            String   @default("[]") // JSON: StepTemplate[]
  requiredCapabilities     String   @default("[]") // JSON: string[]
  estimatedDurationMinutes Int?
  maxConcurrentInstances   Int?
  tags                     String   @default("[]") // JSON: string[]
  createdBy                String
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  // Relations
  instances ProcessInstance[]

  @@index([name])
  @@index([status])
  @@index([createdBy])
}

model ProcessInstance {
  id                    String    @id @default(uuid())
  processDefinitionId   String
  processName           String
  description           String?
  status                String    @default("pending") // ProcessInstanceStatus
  priority              String    @default("normal") // Priority: 'low' | 'normal' | 'high' | 'critical'
  currentStepIndex      Int       @default(0)
  progress              Int       @default(0) // 0-100
  preferredRobotIds     String    @default("[]") // JSON: string[]
  assignedRobotIds      String    @default("[]") // JSON: string[]
  scheduledAt           DateTime?
  startedAt             DateTime?
  completedAt           DateTime?
  estimatedCompletionAt DateTime?
  inputData             String?   // JSON: Record<string, unknown>
  outputData            String?   // JSON: Record<string, unknown>
  errorMessage          String?
  createdBy             String
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  processDefinition ProcessDefinition @relation(fields: [processDefinitionId], references: [id], onDelete: Cascade)
  steps             StepInstance[]
  robotTasks        RobotTask[]

  @@index([processDefinitionId])
  @@index([status])
  @@index([priority])
  @@index([createdBy])
  @@index([createdAt])
}

model StepInstance {
  id                String    @id @default(uuid())
  processInstanceId String
  stepTemplateId    String
  order             Int
  name              String
  description       String?
  actionType        String // StepActionType
  actionConfig      String    @default("{}") // JSON: Record<string, unknown>
  status            String    @default("pending") // StepInstanceStatus
  assignedRobotId   String?
  startedAt         DateTime?
  completedAt       DateTime?
  result            String?   // JSON: StepResult
  error             String?
  retryCount        Int       @default(0)
  maxRetries        Int       @default(3)
  failedRobotIds    String    @default("[]") // JSON: string[] - robots that failed this step
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  processInstance ProcessInstance @relation(fields: [processInstanceId], references: [id], onDelete: Cascade)
  robotTask       RobotTask?

  @@index([processInstanceId])
  @@index([status])
  @@index([order])
}

// ============================================================================
// ROBOT TASK (Work Item for Robots)
// ============================================================================

model RobotTask {
  id                String    @id @default(uuid())
  processInstanceId String?
  stepInstanceId    String?   @unique
  source            String    @default("manual") // RobotTaskSource: 'process' | 'command' | 'manual'
  robotId           String?   // Optional until assigned by TaskDistributor
  priority          String    @default("normal") // Priority
  status            String    @default("pending") // RobotTaskStatus
  actionType        String // StepActionType
  actionConfig      String    @default("{}") // JSON: Record<string, unknown>
  instruction       String
  a2aTaskId         String?
  a2aContextId      String?
  assignedAt        DateTime?
  startedAt         DateTime?
  completedAt       DateTime?
  timeoutMs         Int?
  result            String?   // JSON: RobotTaskResult
  error             String?
  retryCount        Int       @default(0)
  maxRetries        Int       @default(3)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  robot           Robot?           @relation(fields: [robotId], references: [id], onDelete: Cascade)
  processInstance ProcessInstance? @relation(fields: [processInstanceId], references: [id], onDelete: SetNull)
  stepInstance    StepInstance?    @relation(fields: [stepInstanceId], references: [id], onDelete: SetNull)

  @@index([robotId])
  @@index([processInstanceId])
  @@index([status])
  @@index([priority])
  @@index([source])
  @@index([createdAt])
}

// ============================================================================
// AI EXPLAINABILITY (EU AI Act Art. 13, Art. 50)
// ============================================================================

model Decision {
  id           String   @id @default(uuid())
  decisionType String // 'command_interpretation' | 'task_execution' | 'safety_action'
  entityId     String // Foreign key to CommandInterpretation, RobotTask, etc.
  robotId      String

  inputFactors  String // JSON: DecisionInputFactors
  reasoning     String // JSON: string[] - step-by-step reasoning
  modelUsed     String // e.g., 'gemini-2.5-flash'
  confidence    Float
  alternatives  String // JSON: AlternativeConsidered[]
  safetyFactors String // JSON: DecisionSafetyFactors

  createdAt DateTime @default(now())

  // Relation to compliance logs
  complianceLogs ComplianceLog[]

  @@index([entityId])
  @@index([robotId])
  @@index([decisionType])
  @@index([createdAt])
}

// ============================================================================
// COMPLIANCE LOGGING (EU AI Act Art. 12, GDPR Art. 30, Machinery Regulation)
// ============================================================================

model ComplianceLog {
  id         String @id @default(uuid())
  sessionId  String // Session identifier for grouping related logs
  robotId    String // Robot that generated the event
  operatorId String? // User/operator ID (null for autonomous operations)

  // Event classification
  eventType String // 'ai_decision' | 'safety_action' | 'command_execution' | 'system_event' | 'access_audit'
  severity  String @default("info") // 'debug' | 'info' | 'warning' | 'error' | 'critical'

  // Encrypted payload (AES-256-GCM)
  payloadEncrypted String // Base64-encoded encrypted JSON payload
  payloadIv        String // Base64-encoded initialization vector
  payloadHash      String // SHA-256 hash of unencrypted payload for verification

  // ML model tracking (for AI decisions)
  modelVersion String? // e.g., 'gemini-2.0-flash'
  modelHash    String? // Hash of model configuration

  // Input-output matching (for traceability)
  inputHash  String? // SHA-256 hash of input data
  outputHash String? // SHA-256 hash of output data

  // Hash chain for tamper evidence
  previousHash String // Hash of previous log entry (empty string for first entry)
  currentHash  String // SHA-256(previousHash + timestamp + payloadHash + eventType)

  // Link to AI Explainability system
  decisionId String?
  decision   Decision? @relation(fields: [decisionId], references: [id], onDelete: SetNull)

  // Timestamps
  timestamp DateTime @default(now())

  // Immutability flag - prevents updates/deletes at application level
  immutable Boolean @default(true)

  // Retention management (Task 24)
  retentionExpiresAt DateTime? // When this log can be deleted
  legalHoldId        String?   // If under legal hold, references LegalHold.id

  // Relations
  accessLogs ComplianceLogAccess[]

  @@index([sessionId])
  @@index([retentionExpiresAt])
  @@index([robotId])
  @@index([operatorId])
  @@index([eventType])
  @@index([severity])
  @@index([timestamp])
  @@index([decisionId])
  @@index([currentHash])
}

model ComplianceLogAccess {
  id        String   @id @default(uuid())
  logId     String
  userId    String? // User who accessed (null for system access)
  accessType String // 'view' | 'export' | 'verify' | 'audit'
  ipAddress String?
  userAgent String?
  timestamp DateTime @default(now())

  // Relations
  log ComplianceLog @relation(fields: [logId], references: [id], onDelete: Cascade)

  @@index([logId])
  @@index([userId])
  @@index([timestamp])
}

// ============================================================================
// RETENTION & AUDIT TRAIL MANAGEMENT (EU AI Act Art. 12, GDPR Art. 30)
// ============================================================================

model RetentionPolicy {
  id            String   @id @default(uuid())
  eventType     String   @unique // 'ai_decision' | 'safety_action' | 'command_execution' | 'system_event' | 'access_audit'
  retentionDays Int      // Days to retain logs (e.g., 3650 = 10 years)
  description   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([eventType])
}

model LegalHold {
  id        String    @id @default(uuid())
  name      String
  reason    String
  createdBy String    // User ID who created the hold
  startDate DateTime  @default(now())
  endDate   DateTime?
  isActive  Boolean   @default(true)
  logIds    String[]  // Array of ComplianceLog IDs under hold
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([isActive])
  @@index([createdBy])
}

// GDPR Article 30 - Records of Processing Activities
model RopaEntry {
  id                    String   @id @default(uuid())
  processingActivity    String   // Name of the processing activity
  purpose               String   // Purpose of processing
  dataCategories        String[] // Types of personal data processed
  dataSubjects          String[] // Categories of data subjects
  recipients            String[] // Recipients of the data
  thirdCountryTransfers String?  // International transfers info
  retentionPeriod       String   // How long data is retained
  securityMeasures      String[] // Technical/organizational security measures
  legalBasis            String   // GDPR legal basis (consent, contract, legal obligation, etc.)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([processingActivity])
}

// AI Provider Documentation (EU AI Act transparency requirements)
model ProviderDocumentation {
  id           String    @id @default(uuid())
  providerName String    // e.g., 'Google Gemini', 'OpenAI'
  modelVersion String    // e.g., 'gemini-2.0-flash'
  documentType String    // 'technical_doc' | 'risk_assessment' | 'conformity_declaration' | 'user_manual'
  documentUrl  String?   // URL to external documentation
  content      String    // Documentation content or summary
  validFrom    DateTime  // When this documentation became valid
  validTo      DateTime? // When this documentation expires (null = still valid)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([providerName])
  @@index([modelVersion])
  @@index([documentType])
}

// ============================================================================
// GDPR RIGHTS MANAGEMENT (GDPR Articles 15-22)
// ============================================================================

// Core GDPR Request model - handles all request types
model GDPRRequest {
  id              String    @id @default(uuid())
  userId          String
  requestType     String    // 'access' | 'rectification' | 'erasure' | 'restriction' | 'portability' | 'objection' | 'adm_review'
  status          String    @default("pending") // 'pending' | 'acknowledged' | 'in_progress' | 'completed' | 'rejected'

  // SLA tracking
  submittedAt     DateTime  @default(now())
  acknowledgedAt  DateTime?
  slaDeadline     DateTime  // 30 days from submission (or 72 hours for ADM acknowledgment)
  completedAt     DateTime?

  // Request details (JSON for flexibility per type)
  requestData     String    @default("{}") // JSON: type-specific request data
  responseData    String?   // JSON: result data (export path, changes made, etc.)

  // Verification for sensitive requests
  verificationToken   String?   @unique
  verificationExpires DateTime?
  verifiedAt          DateTime?

  // Processing
  assignedTo      String?   // Admin user ID handling the request
  internalNotes   String?   // Admin notes (not visible to user)
  rejectionReason String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  statusHistory   GDPRRequestStatusHistory[]
  admReview       ADMReviewQueue?

  @@index([userId])
  @@index([requestType])
  @@index([status])
  @@index([slaDeadline])
  @@index([submittedAt])
}

// Status history for audit trail
model GDPRRequestStatusHistory {
  id          String   @id @default(uuid())
  requestId   String
  fromStatus  String?
  toStatus    String
  changedBy   String?  // User ID who made the change (null for system)
  reason      String?
  timestamp   DateTime @default(now())

  request     GDPRRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@index([timestamp])
}

// User consent tracking (GDPR consent requirements)
model UserConsent {
  id            String    @id @default(uuid())
  userId        String
  consentType   String    // 'marketing' | 'analytics' | 'ai_processing' | 'data_sharing' | 'third_party'
  granted       Boolean   @default(false)
  grantedAt     DateTime?
  revokedAt     DateTime?
  version       String    // Consent policy version at time of consent
  ipAddress     String?   // IP at time of consent (for proof)
  userAgent     String?   // Browser/device info
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, consentType])
  @@index([userId])
  @@index([consentType])
}

// Data Processing Restriction tracking (GDPR Art. 18)
model DataRestriction {
  id            String    @id @default(uuid())
  userId        String
  scope         String    // 'all' | 'ai_processing' | 'sharing' | 'marketing' | specific data category
  reason        String    // 'accuracy_disputed' | 'unlawful_processing' | 'no_longer_needed' | 'objection_pending'
  gdprRequestId String?   // Link to original GDPR request if applicable
  startDate     DateTime  @default(now())
  endDate       DateTime?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
  @@index([scope])
}

// ADM (Automated Decision Making) Human Review Queue (GDPR Art. 22)
model ADMReviewQueue {
  id              String    @id @default(uuid())
  gdprRequestId   String    @unique  // Links to GDPRRequest of type 'adm_review'
  decisionId      String    // Original AI Decision that's being contested
  userId          String    // User contesting the decision

  contestReason   String    // Why the user is contesting
  userEvidence    String?   // JSON: Evidence provided by user

  status          String    @default("queued") // 'queued' | 'assigned' | 'under_review' | 'decision_overturned' | 'decision_upheld'
  priority        String    @default("normal") // 'low' | 'normal' | 'high' | 'urgent'

  assignedTo      String?   // Admin assigned to review
  reviewNotes     String?   // Admin review notes
  reviewOutcome   String?   // Final decision explanation

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  completedAt     DateTime?

  gdprRequest     GDPRRequest @relation(fields: [gdprRequestId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([priority])
  @@index([assignedTo])
  @@index([decisionId])
  @@index([createdAt])
}

// ============================================================================
// INCIDENT REPORTING (EU AI Act Art. 73, GDPR Art. 33-34, NIS2 Art. 23, CRA Art. 14)
// ============================================================================

model Incident {
  id             String   @id @default(uuid())
  incidentNumber String   @unique // INC-2026-001 format

  // Classification
  type     String // 'safety' | 'security' | 'data_breach' | 'ai_malfunction' | 'vulnerability'
  severity String // 'critical' | 'high' | 'medium' | 'low'
  status   String @default("detected") // 'detected' | 'investigating' | 'contained' | 'resolved' | 'closed'

  // Description
  title       String
  description String
  rootCause   String?
  resolution  String?

  // Risk Assessment
  riskScore            Int?     // 0-100
  affectedDataSubjects Int?     // For GDPR assessment
  dataCategories       String[] // Personal data types affected

  // Timestamps
  detectedAt  DateTime
  containedAt DateTime?
  resolvedAt  DateTime?
  closedAt    DateTime?

  // Evidence Links
  robotId          String?
  complianceLogIds String[] // Links to ComplianceLog entries
  alertIds         String[] // Links to Alert entries

  // System State Snapshot
  systemSnapshot String? // JSON: SystemSnapshot

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Relations
  robot         Robot?                 @relation(fields: [robotId], references: [id], onDelete: SetNull)
  notifications IncidentNotification[]

  @@index([type])
  @@index([severity])
  @@index([status])
  @@index([detectedAt])
  @@index([robotId])
}

model IncidentNotification {
  id         String @id @default(uuid())
  incidentId String

  // Authority & Regulation
  authority  String // 'ai_act_authority' | 'dpa' | 'data_subject' | 'csirt' | 'enisa'
  regulation String // 'ai_act' | 'gdpr' | 'nis2' | 'cra'

  // Notification Type & Deadline
  notificationType String   // 'early_warning' | 'initial' | 'intermediate' | 'final'
  deadlineHours    Int      // Hours from incident detection
  dueAt            DateTime

  // Status
  status         String    @default("pending") // 'pending' | 'draft' | 'sent' | 'acknowledged' | 'overdue'
  sentAt         DateTime?
  acknowledgedAt DateTime?

  // Content
  templateId String?
  content    String? // Generated/edited notification content

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  sentBy    String?

  // Relations
  incident Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@index([incidentId])
  @@index([status])
  @@index([dueAt])
  @@index([authority])
  @@index([regulation])
}

model NotificationTemplate {
  id         String  @id @default(uuid())
  name       String
  regulation String  // 'ai_act' | 'gdpr' | 'nis2' | 'cra'
  authority  String  // 'ai_act_authority' | 'dpa' | 'data_subject' | 'csirt' | 'enisa'
  type       String  // 'early_warning' | 'initial' | 'intermediate' | 'final'
  subject    String
  body       String  // Template with {{placeholders}}
  isDefault  Boolean @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([regulation, authority, type, isDefault])
  @@index([regulation])
  @@index([authority])
}

// ============================================================================
// HUMAN OVERSIGHT (EU AI Act Art. 14)
// ============================================================================

// Manual Control Session - tracks when operators take manual control of robots
model ManualControlSession {
  id                 String    @id @default(uuid())
  robotId            String
  operatorId         String
  reason             String
  startedAt          DateTime  @default(now())
  endedAt            DateTime?
  isActive           Boolean   @default(true)
  speedLimitMmPerSec Int       @default(250)  // ISO 10218-1 reduced speed limit
  forceLimitN        Int       @default(140)  // ISO/TS 15066 force limit

  @@index([robotId])
  @@index([operatorId])
  @@index([isActive])
}

// Verification Schedule - periodic checks to prevent automation bias (Art. 14(3))
model VerificationSchedule {
  id              String   @id @default(uuid())
  name            String
  description     String?
  intervalMinutes Int      // How often verification is required
  robotScope      String   @default("all") // 'all' | 'robot' | 'zone'
  scopeId         String?  // Specific robot or zone ID
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  completions VerificationCompletion[]

  @@index([isActive])
  @@index([robotScope])
}

// Verification Completion - tracks when verifications are completed
model VerificationCompletion {
  id          String   @id @default(uuid())
  scheduleId  String
  operatorId  String
  robotId     String?
  status      String   // 'completed' | 'skipped' | 'deferred'
  notes       String?
  completedAt DateTime @default(now())

  // Relations
  schedule VerificationSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@index([scheduleId])
  @@index([operatorId])
  @@index([completedAt])
}

// Oversight Log - audit trail of all human oversight actions
model OversightLog {
  id         String   @id @default(uuid())
  actionType String   // 'manual_mode_activated' | 'task_reassigned' | etc.
  operatorId String
  robotId    String?
  taskId     String?
  decisionId String?
  reason     String
  details    String   @default("{}") // JSON for action-specific data
  timestamp  DateTime @default(now())

  @@index([actionType])
  @@index([operatorId])
  @@index([robotId])
  @@index([timestamp])
}

// Anomaly Record - tracks detected anomalies for human review
model AnomalyRecord {
  id             String    @id @default(uuid())
  robotId        String
  anomalyType    String    // 'confidence_drop' | 'behavior_drift' | 'performance_degradation' | 'safety_warning'
  severity       String    // 'low' | 'medium' | 'high' | 'critical'
  description    String
  detectedAt     DateTime  @default(now())
  acknowledgedAt DateTime?
  acknowledgedBy String?
  resolvedAt     DateTime?
  resolution     String?
  isActive       Boolean   @default(true)

  @@index([robotId])
  @@index([anomalyType])
  @@index([severity])
  @@index([isActive])
  @@index([detectedAt])
}

// ============================================================================
// HUMAN APPROVAL WORKFLOWS (GDPR Art. 22, AI Act Art. 14)
// ============================================================================

// Approval Request - represents a single approval needing human review
model ApprovalRequest {
  id              String    @id @default(uuid())
  requestNumber   String    @unique // APR-2026-001 format
  entityType      String    // 'performance_evaluation' | 'shift_change' | 'disciplinary_action' | 'safety_parameter_modification' | 'software_update'
  entityId        String
  entityData      String    @default("{}") // JSON snapshot of entity at request time
  approvalType    String    // 'single_approval' | 'dual_approval' | 'chain_approval'
  priority        String    @default("normal") // 'low' | 'normal' | 'high' | 'critical' | 'urgent'
  status          String    @default("pending") // 'pending' | 'in_progress' | 'approved' | 'rejected' | 'escalated' | 'expired' | 'cancelled'
  affectedUserId  String?   // Worker affected by this decision (GDPR Art. 22)
  affectedRobotId String?   // Robot affected (for safety changes)
  slaHours        Int       // SLA deadline in hours
  slaDeadline     DateTime  // Calculated deadline
  escalatedAt     DateTime?
  escalationLevel Int       @default(0)
  requestedBy     String
  requestReason   String
  blocksExecution Boolean   @default(true)
  rollbackPlan    String?   // JSON: RollbackPlan for safety-critical changes
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  completedAt     DateTime?

  // Relations
  chain           ApprovalChain?
  steps           ApprovalStep[]
  workerViewpoint WorkerViewpoint?
  decisionContest DecisionContest?
  statusHistory   ApprovalStatusHistory[]

  @@index([status])
  @@index([priority])
  @@index([entityType])
  @@index([affectedUserId])
  @@index([slaDeadline])
  @@index([requestedBy])
  @@index([createdAt])
}

// Approval Chain - defines multi-step approval sequence
model ApprovalChain {
  id                String   @id @default(uuid())
  approvalRequestId String   @unique
  name              String
  description       String?
  requiredSteps     Int
  currentStepIndex  Int      @default(0)
  isSequential      Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  approvalRequest ApprovalRequest @relation(fields: [approvalRequestId], references: [id], onDelete: Cascade)

  @@index([approvalRequestId])
}

// Approval Step - individual approval action by an approver
model ApprovalStep {
  id                String    @id @default(uuid())
  approvalRequestId String
  stepOrder         Int
  approverRole      String    // 'supervisor' | 'manager' | 'safety_officer' | 'admin'
  assignedTo        String?   // Specific user assigned (null = any user with role)
  status            String    @default("pending") // 'pending' | 'awaiting' | 'approved' | 'rejected' | 'skipped'
  decision          String?   // 'approve' | 'reject' | 'defer' | 'request_info'
  decidedBy         String?
  decisionNotes     String?
  activeEngagement  Boolean   @default(false) // Art. 14: Did approver actively engage?
  reviewDurationSec Int?      // Time spent reviewing (anti-rubber-stamp)
  competenceVerified Boolean  @default(false) // Has approver been verified competent?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  assignedAt        DateTime?
  decidedAt         DateTime?

  // Relations
  approvalRequest ApprovalRequest @relation(fields: [approvalRequestId], references: [id], onDelete: Cascade)

  @@index([approvalRequestId])
  @@index([stepOrder])
  @@index([approverRole])
  @@index([assignedTo])
  @@index([status])
}

// Approval Status History - audit trail for approval requests
model ApprovalStatusHistory {
  id                String   @id @default(uuid())
  approvalRequestId String
  fromStatus        String?
  toStatus          String
  changedBy         String?
  reason            String?
  metadata          String   @default("{}") // JSON: additional context
  timestamp         DateTime @default(now())

  // Relations
  approvalRequest ApprovalRequest @relation(fields: [approvalRequestId], references: [id], onDelete: Cascade)

  @@index([approvalRequestId])
  @@index([timestamp])
}

// Worker Viewpoint - GDPR Art. 22 right to express viewpoint
model WorkerViewpoint {
  id                String    @id @default(uuid())
  approvalRequestId String    @unique
  workerId          String
  statement         String
  supportingDocs    String    @default("[]") // JSON: array of document references
  status            String    @default("submitted") // 'submitted' | 'acknowledged' | 'considered' | 'addressed'
  acknowledgedAt    DateTime?
  acknowledgedBy    String?
  response          String?
  respondedAt       DateTime?
  respondedBy       String?
  submittedAt       DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  approvalRequest ApprovalRequest @relation(fields: [approvalRequestId], references: [id], onDelete: Cascade)

  @@index([workerId])
  @@index([status])
}

// Decision Contest - Worker right to contest automated decisions
model DecisionContest {
  id                        String    @id @default(uuid())
  approvalRequestId         String?   @unique
  decisionId                String    // Original AI Decision being contested
  workerId                  String
  contestReason             String
  contestEvidence           String?   // JSON: Evidence provided by worker
  requestedOutcome          String?
  status                    String    @default("submitted") // 'submitted' | 'under_review' | 'human_intervention_granted' | 'decision_overturned' | 'decision_upheld'
  priority                  String    @default("normal")
  assignedTo                String?   // Admin assigned to review
  reviewNotes               String?
  reviewOutcome             String?
  humanInterventionProvided Boolean   @default(false)
  newDecisionData           String?   // JSON: Modified decision if overturned
  submittedAt               DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
  reviewedAt                DateTime?
  completedAt               DateTime?

  // Relations
  approvalRequest ApprovalRequest? @relation(fields: [approvalRequestId], references: [id], onDelete: SetNull)

  @@index([decisionId])
  @@index([workerId])
  @@index([status])
  @@index([submittedAt])
}

// Escalation Rule - defines when and how to escalate
model EscalationRule {
  id               String   @id @default(uuid())
  name             String
  description      String?
  entityType       String   // Which entity type this applies to
  approvalType     String?  // Specific approval type (null = all)
  triggerCondition String   // 'overdue' | 'near_deadline' | 'high_priority' | 'repeated_rejection'
  triggerThreshold Int      // Hours overdue, or percentage of deadline
  escalateTo       String   // Role to escalate to
  notifyOriginal   Boolean  @default(true)
  notifyAdmin      Boolean  @default(true)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([entityType])
  @@index([isActive])
}

// ============================================================================
// COMPLIANCE MONITORING DASHBOARD (Task 34)
// ============================================================================

// Training Record - DGUV training compliance tracking
model TrainingRecord {
  id               String   @id @default(uuid())
  userId           String
  userName         String
  userEmail        String?
  trainingType     String   // 'operator_competence' | 'safety_training' | 'emergency_response' | 'first_aid' | 'maintenance_training'
  completedAt      DateTime
  expiresAt        DateTime
  certificateUrl   String?
  trainingProvider String?
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([userId])
  @@index([trainingType])
  @@index([expiresAt])
}

// Inspection Schedule - DGUV Vorschrift 3 and ISO inspections
model InspectionSchedule {
  id                 String   @id @default(uuid())
  inspectionType     String   // 'electrical' | 'force_verification' | 'biomechanical' | 'safety_function' | 'protective_device'
  robotId            String?
  robotName          String?
  lastInspectionDate DateTime
  nextDueDate        DateTime
  intervalYears      Int
  inspectorName      String?
  inspectorCompany   String?
  reportUrl          String?
  notes              String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([inspectionType])
  @@index([robotId])
  @@index([nextDueDate])
}

// Risk Assessment - tracks risk assessment documents and review schedules
model RiskAssessment {
  id                String   @id @default(uuid())
  assessmentType    String   // 'ai_risk' | 'machinery_risk' | 'dpia' | 'cybersecurity' | 'occupational'
  name              String
  version           String
  description       String?
  lastUpdated       DateTime
  nextReviewDate    DateTime
  triggerConditions String[] // Conditions that trigger an update
  triggeredUpdates  String[] // History of triggered updates
  documentUrl       String?
  responsiblePerson String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([assessmentType])
  @@index([nextReviewDate])
}

// Compliance Gap - tracks gaps in regulatory compliance
model ComplianceGap {
  id               String    @id @default(uuid())
  framework        String    // 'ai_act' | 'machinery_regulation' | 'gdpr' | 'nis2' | 'cra' | 'red' | 'dguv'
  requirement      String
  articleReference String    // e.g., "Art. 12" or "Annex IV.2"
  severity         String    // 'critical' | 'high' | 'medium' | 'low'
  description      String
  currentState     String
  targetState      String
  remediation      String
  estimatedEffort  String    @default("medium") // 'low' | 'medium' | 'high'
  dueDate          DateTime?
  assignedTo       String?
  status           String    @default("open") // 'open' | 'in_progress' | 'closed'
  closedAt         DateTime?
  closedBy         String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([framework])
  @@index([severity])
  @@index([status])
  @@index([dueDate])
}

// Regulatory Deadline - tracks key regulatory deadlines
model RegulatoryDeadline {
  id                    String   @id @default(uuid())
  framework             String   // 'ai_act' | 'machinery_regulation' | 'gdpr' | 'nis2' | 'cra' | 'red' | 'dguv'
  name                  String
  deadline              DateTime
  description           String
  requirements          String[] // List of requirements to meet
  completedRequirements String[] // Requirements already met
  priority              String   @default("medium") // 'critical' | 'high' | 'medium' | 'low'
  notes                 String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([framework])
  @@index([deadline])
  @@index([priority])
}

// Compliance Activity - tracks recent compliance-related activities
model ComplianceActivity {
  id          String    @id @default(uuid())
  type        String    // 'gap_closed' | 'document_renewed' | 'training_completed' | 'inspection_done' | 'assessment_updated'
  description String
  framework   String?   // Optional framework association
  entityId    String?   // ID of related entity (gap, document, training, etc.)
  entityType  String?   // Type of related entity
  userId      String?
  userName    String?
  timestamp   DateTime  @default(now())

  @@index([type])
  @@index([framework])
  @@index([timestamp])
}

// ============================================================================
// TELEOPERATION DATA COLLECTION (VLA Data Strategy)
// ============================================================================

// TeleoperationSession - Data collection session for demonstrations
model TeleoperationSession {
  id              String    @id @default(uuid())
  operatorId      String
  robotId         String
  type            String    // vr_quest, vr_vision_pro, bilateral_aloha, kinesthetic
  status          String    @default("created") // created, recording, paused, completed, failed
  startedAt       DateTime?
  endedAt         DateTime?
  frameCount      Int       @default(0)
  duration        Float?    // seconds
  fps             Int       @default(30)
  languageInstr   String?   // Language instruction for this demonstration
  qualityScore    Float?    // Computed quality score (0-100)
  exportedDatasetId String? // If exported to a Dataset
  errorMessage    String?   // Error message if failed
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  frames          TeleoperationFrame[]

  @@index([operatorId])
  @@index([robotId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
}

// ============================================================================
// TRAINING DATA COMPLIANCE (EU AI Act GPAI Requirements)
// ============================================================================

// DatasetProvenance - Source documentation for training datasets
model DatasetProvenance {
  id                String   @id @default(uuid())
  datasetId         String   @unique
  sourceType        String   // collected, purchased, synthetic, open_source, contributed
  sourceName        String?  // Name of source (e.g., "Open X-Embodiment")
  sourceUrl         String?  // URL to source
  collectionMethod  String?  // How data was collected
  collectionPeriod  Json?    // { start: Date, end: Date }
  labelingProcedure String?  // How data was labeled
  annotatorInfo     String?  // Information about annotators
  cleaningSteps     Json?    // string[] - Data cleaning steps applied
  licenseType       String?  // License under which data is held
  copyrightCompliance String? // Copyright compliance measures
  chainOfCustody    Json?    // Array of custody transfers
  recordedAt        DateTime @default(now())
  recordedBy        String
  updatedAt         DateTime @updatedAt

  @@index([datasetId])
  @@index([sourceType])
}

// TrainingDataSummary - AI Act GPAI training data summary per model version
model TrainingDataSummary {
  id                String   @id @default(uuid())
  modelVersionId    String   @unique
  datasetIds        Json     // string[] - Datasets used in training
  totalTrajectories Int
  publicDatasets    Json?    // string[] - IDs of public datasets
  privateDatasets   Json?    // string[] - IDs of private datasets
  webScrapingSources Json?   // string[] - Web scraping sources if any
  copyrightMeasures String   // Copyright compliance measures
  processingPurposes Json    // string[] - Purposes of processing
  knownGaps         Json     // string[] - Known data gaps
  limitations       Json?    // string[] - Known limitations
  generatedAt       DateTime @default(now())
  lastUpdated       DateTime @default(now())
  nextUpdateDue     DateTime // 6 months from lastUpdated per AI Act
  generatedBy       String

  @@index([modelVersionId])
  @@index([nextUpdateDue])
}

// BiasAssessment - Bias and fairness documentation per model version
model BiasAssessment {
  id                   String   @id @default(uuid())
  modelVersionId       String
  assessmentVersion    Int      @default(1)
  demographicCoverage  Json     // Record<string, string> - coverage by demographic
  geographicCoverage   Json?    // Record<string, string> - coverage by region
  taskCoverage         Json?    // Record<string, string> - coverage by task type
  knownLimitations     Json     // string[] - Known limitations
  potentialBiasSources Json     // string[] - Potential bias sources
  mitigationMeasures   Json     // string[] - Measures taken to mitigate bias
  testingResults       Json?    // Bias testing results
  assessedBy           String
  reviewedBy           String?
  assessmentDate       DateTime @default(now())
  reviewedDate         DateTime?
  status               String   @default("draft") // draft, reviewed, approved
  notes                String?

  @@unique([modelVersionId, assessmentVersion])
  @@index([modelVersionId])
  @@index([status])
  @@index([assessmentDate])
}

// TeleoperationFrame - Individual frame in a teleoperation session
model TeleoperationFrame {
  id              String   @id @default(uuid())
  sessionId       String
  frameIndex      Int      // Sequential frame index
  timestamp       Float    // seconds from session start
  jointPositions  Json     // array of floats
  jointVelocities Json?    // array of floats (optional)
  action          Json     // commanded action
  imagePath       String?  // RustFS path to camera frame
  depthImagePath  String?  // RustFS path to depth image (optional)
  isIntervention  Boolean  @default(false) // Human intervention marker

  // Relations
  session         TeleoperationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, frameIndex])
  @@index([sessionId])
  @@index([timestamp])
}

// ============================================================================
// SYNTHETIC DATA GENERATION
// ============================================================================

model SyntheticJob {
  id                     String    @id @default(uuid())
  task                   String    // Isaac Lab task name
  embodiment             String    // Embodiment tag
  trajectoryCount        Int       // Requested trajectory count
  config                 Json      // SyntheticJobConfig
  status                 String    @default("pending") // pending, queued, running, processing, completed, failed, cancelled
  progress               Int       @default(0) // 0-100
  generatedCount         Int       @default(0)
  successfulCount        Int       @default(0)
  failedCount            Int       @default(0)
  processingRate         Float?    // trajectories per second
  estimatedTimeRemaining Float?    // seconds
  outputDatasetId        String?
  errorMessage           String?
  startedAt              DateTime?
  completedAt            DateTime?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  validations SimToRealValidation[]

  @@index([status])
  @@index([task])
  @@index([embodiment])
  @@index([createdAt])
}

model SimToRealValidation {
  id              String   @id @default(uuid())
  syntheticJobId  String
  modelVersionId  String
  validationDate  DateTime @default(now())
  simSuccessRate  Float
  realSuccessRate Float
  domainGapScore  Float
  realTestCount   Int
  taskCategories  Json     // string[]
  perTaskMetrics  Json?    // Record<string, { simSuccess, realSuccess, gap }>
  notes           String?

  syntheticJob SyntheticJob @relation(fields: [syntheticJobId], references: [id], onDelete: Cascade)

  @@index([syntheticJobId])
  @@index([modelVersionId])
  @@index([validationDate])
}

// ============================================================================
// FEDERATED LEARNING
// ============================================================================

model FederatedRound {
  id                    String    @id @default(uuid())
  status                String    @default("created") // created, selecting, distributing, training, collecting, aggregating, completed, failed
  globalModelVersion    String
  newModelVersion       String?
  config                Json      // FederatedRoundConfig
  participantCount      Int       @default(0)
  completedParticipants Int       @default(0)
  failedParticipants    Int       @default(0)
  totalLocalSamples     Int       @default(0)
  metrics               Json?     // RoundMetrics
  startedAt             DateTime?
  completedAt           DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  participants FederatedParticipant[]

  @@index([status])
  @@index([globalModelVersion])
  @@index([createdAt])
}

model FederatedParticipant {
  id                String    @id @default(uuid())
  roundId           String
  robotId           String
  status            String    @default("selected") // selected, model_received, training, uploaded, failed, timeout
  localSamples      Int?
  localLoss         Float?
  aggregationWeight Float?
  privacyBudgetUsed Float?
  failureReason     String?
  modelReceivedAt   DateTime?
  trainingStartedAt DateTime?
  uploadedAt        DateTime?

  round FederatedRound @relation(fields: [roundId], references: [id], onDelete: Cascade)

  @@unique([roundId, robotId])
  @@index([roundId])
  @@index([robotId])
  @@index([status])
}

model RobotPrivacyBudget {
  id                 String   @id @default(uuid())
  robotId            String   @unique
  totalEpsilon       Float    @default(10.0)
  usedEpsilon        Float    @default(0.0)
  remainingEpsilon   Float    @default(10.0)
  roundsParticipated Int      @default(0)
  lastUpdated        DateTime @default(now())

  @@index([robotId])
}

model InterventionRecord {
  id               String   @id @default(uuid())
  robotId          String
  task             String
  interventionType String   // correction, demonstration, abort
  confidenceBefore Float?
  confidenceAfter  Float?
  description      String?
  timestamp        DateTime @default(now())

  @@index([robotId])
  @@index([task])
  @@index([timestamp])
}

// ============================================================================
// ACTIVE LEARNING
// ============================================================================

model PredictionLog {
  id           String    @id @default(uuid())
  modelId      String
  robotId      String
  inputHash    String
  taskCategory String
  environment  String
  confidence   Float
  wasCorrect   Boolean?
  metadata     Json?
  timestamp    DateTime  @default(now())

  @@index([modelId, taskCategory])
  @@index([modelId, environment])
  @@index([modelId, timestamp])
  @@index([timestamp])
}

model CollectionTarget {
  id             String   @id @default(uuid())
  targetType     String   // task, environment, task_environment
  targetName     String
  priorityScore  Float    @default(0.5)
  estimatedDemos Int
  collectedDemos Int      @default(0)
  status         String   @default("active") // active, completed, paused, cancelled
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([status])
  @@index([targetType])
  @@index([priorityScore])
}

// ============================================================================
// VLA (VISION-LANGUAGE-ACTION) TRAINING MANAGEMENT
// ============================================================================

// RobotType - Robot embodiment configurations for VLA training
model RobotType {
  id                String   @id @default(uuid())
  name              String   @unique
  manufacturer      String
  model             String
  actionDim         Int      // VLA action dimensions
  proprioceptionDim Int      // VLA observation dimensions
  cameras           String   @default("[]") // JSON: CameraConfig[]
  capabilities      String[] // Robot capabilities array
  limits            String   @default("{}") // JSON: JointLimits
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  datasets         Dataset[]
  skillDefinitions SkillDefinition[]
  embodiments      Embodiment[]

  @@index([manufacturer])
}

// Embodiment - YAML-based embodiment configurations for VLA pipeline
model Embodiment {
  id                String   @id @default(uuid())
  tag               String   @unique  // e.g., 'unitree_h1', 'so101_arm'
  manufacturer      String
  model             String
  description       String?
  configYaml        String             // Full YAML configuration content
  actionDim         Int                // Action space dimension
  proprioceptionDim Int                // Proprioception dimension
  robotTypeId       String?            // Optional link to RobotType
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  robotType         RobotType? @relation(fields: [robotTypeId], references: [id], onDelete: SetNull)

  @@index([robotTypeId])
  @@index([manufacturer])
  @@index([tag])
}

// SkillDefinition - Learnable robot skills
model SkillDefinition {
  id                   String   @id @default(uuid())
  name                 String
  version              String
  description          String?
  parametersSchema     String   @default("{}") // JSON: Zod-compatible parameter validation (JSON Schema format)
  defaultParameters    String   @default("{}") // JSON: Record<string, unknown>
  preconditions        String   @default("[]") // JSON: Condition[]
  postconditions       String   @default("[]") // JSON: Condition[]
  requiredCapabilities String[] // Array of required robot capabilities
  timeout              Int?     // Execution timeout in seconds
  maxRetries           Int      @default(3)
  status               String   @default("draft") // 'draft' | 'published' | 'deprecated' | 'archived'
  linkedModelVersionId String?  // Optional link to a trained model version
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  compatibleRobotTypes RobotType[]
  datasets             Dataset[]
  modelVersions        ModelVersion[]
  skillChainSteps      SkillChainStep[]

  @@unique([name, version])
  @@index([status])
  @@index([linkedModelVersionId])
}

// SkillChain - A sequence of skills to be executed together
model SkillChain {
  id                String   @id @default(uuid())
  name              String
  description       String?
  status            String   @default("draft") // 'draft' | 'active' | 'archived'
  estimatedDuration Int?     // Total estimated duration in seconds
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  steps SkillChainStep[]

  @@index([status])
  @@index([name])
}

// SkillChainStep - Individual step in a skill chain
model SkillChainStep {
  id              String @id @default(uuid())
  chainId         String
  skillId         String
  order           Int    // Order in the chain (0-indexed)
  parameters      String @default("{}") // JSON: Record<string, unknown>
  inputMapping    String @default("{}") // JSON: Record<string, string> - Map previous output to input
  onFailure       String @default("abort") // 'abort' | 'skip' | 'retry'
  maxRetries      Int?   // Override skill's default maxRetries
  timeoutOverride Int?   // Override skill's default timeout

  // Relations
  chain SkillChain      @relation(fields: [chainId], references: [id], onDelete: Cascade)
  skill SkillDefinition @relation(fields: [skillId], references: [id], onDelete: Restrict)

  @@unique([chainId, order])
  @@index([chainId])
  @@index([skillId])
}

// Dataset - Training datasets in LeRobot v3 format
model Dataset {
  id                 String   @id @default(uuid())
  name               String
  description        String?
  robotTypeId        String
  skillId            String?
  storagePath        String   // MinIO location
  lerobotVersion     String   // LeRobot v3 format version
  fps                Int
  totalFrames        Int
  totalDuration      Float    // Duration in seconds
  demonstrationCount Int
  qualityScore       Int?     // 0-100
  infoJson           String   @default("{}") // JSON: LeRobot metadata
  statsJson          String   @default("{}") // JSON: LeRobot stats
  status             String   @default("uploading") // 'uploading' | 'validating' | 'ready' | 'failed'
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  robotType    RobotType        @relation(fields: [robotTypeId], references: [id])
  skill        SkillDefinition? @relation(fields: [skillId], references: [id])
  trainingJobs TrainingJob[]

  @@index([robotTypeId])
  @@index([skillId])
  @@index([status])
}

// TrainingJob - Training job queue entries
model TrainingJob {
  id                 String    @id @default(uuid())
  datasetId          String
  baseModel          String    // 'pi0' | 'pi0_6' | 'openvla' | 'groot'
  fineTuneMethod     String    // 'lora' | 'full' | 'oft'
  hyperparameters    String    @default("{}") // JSON: { learning_rate, batch_size, epochs, lora_rank, warmup_steps }
  gpuRequirements    String    @default("{}") // JSON: { count, memory, type }
  status             String    @default("pending") // 'pending' | 'queued' | 'running' | 'completed' | 'failed' | 'cancelled'
  progress           Int       @default(0) // 0-100
  currentEpoch       Int?
  totalEpochs        Int?
  metrics            String    @default("{}") // JSON: training/validation loss curves
  mlflowRunId        String?
  mlflowExperimentId String?
  bullmqJobId        String?   // BullMQ queue tracking
  startedAt          DateTime?
  completedAt        DateTime?
  errorMessage       String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relations
  dataset       Dataset        @relation(fields: [datasetId], references: [id])
  modelVersions ModelVersion[]

  @@index([datasetId])
  @@index([status])
  @@index([baseModel])
}

// ModelVersion - Trained model artifacts
model ModelVersion {
  id                 String   @id @default(uuid())
  skillId            String
  trainingJobId      String
  version            String   // Semantic version string
  artifactUri        String   // MinIO model location
  checkpointUri      String?  // Intermediate checkpoints location
  trainingMetrics    String   @default("{}") // JSON: training metrics
  validationMetrics  String   @default("{}") // JSON: validation metrics
  deploymentStatus   String   @default("staging") // 'staging' | 'canary' | 'production' | 'archived'
  mlflowModelName    String?
  mlflowModelVersion String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  skill       SkillDefinition @relation(fields: [skillId], references: [id])
  trainingJob TrainingJob     @relation(fields: [trainingJobId], references: [id])
  deployments Deployment[]

  @@unique([skillId, version])
  @@index([deploymentStatus])
}

// Deployment - Fleet deployment tracking
model Deployment {
  id                 String    @id @default(uuid())
  modelVersionId     String
  strategy           String    // 'canary' | 'blue_green' | 'rolling'
  targetRobotTypes   String[]  // Robot types to deploy to
  targetZones        String[]  // Zones to deploy to
  trafficPercentage  Int       @default(0) // 0-100
  canaryConfig       String    @default("{}") // JSON: { stages, durations, thresholds }
  rollbackThresholds String    @default("{}") // JSON: { errorRate, latencyP99, failureRate }
  status             String    @default("pending") // 'pending' | 'deploying' | 'canary' | 'production' | 'rolling_back' | 'failed'
  deployedRobotIds   String[]  // Robots successfully deployed
  failedRobotIds     String[]  // Robots that failed deployment
  startedAt          DateTime?
  completedAt        DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relations
  modelVersion ModelVersion @relation(fields: [modelVersionId], references: [id])

  @@index([modelVersionId])
  @@index([status])
}
