// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  // PostgreSQL for production/Kubernetes deployments
  // For local SQLite: provider = "sqlite", DATABASE_URL = "file:./dev.db"
  // For PostgreSQL:   provider = "postgresql", DATABASE_URL = "postgresql://user:pass@host:5432/db"
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ROBOT ENTITIES
// ============================================================================

model Robot {
  id              String   @id @default(uuid())
  name            String
  model           String
  serialNumber    String?  @unique
  status          String   @default("offline") // RobotStatus enum as string
  batteryLevel    Int      @default(100)
  location        String   @default("{}") // JSON: RobotLocation
  lastSeen        DateTime @default(now())
  currentTaskId   String?
  currentTaskName String?
  capabilities    String   @default("[]") // JSON: string[]
  firmware        String?
  ipAddress       String?
  metadata        String?  // JSON: Record<string, unknown>
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // A2A Integration
  a2aEnabled   Boolean @default(false)
  a2aAgentUrl  String?

  // Registration metadata
  registeredAt    DateTime?
  isConnected     Boolean   @default(false)
  lastHealthCheck DateTime?
  baseUrl         String?

  // Relations
  conversations Conversation[]
  telemetryLogs RobotTelemetry[]
  commands      RobotCommand[]
  agentCard     AgentCard?
  endpoints     RobotEndpoints?
  alerts        Alert[]
  robotTasks    RobotTask[]

  @@index([status])
  @@index([a2aEnabled])
}

model RobotTelemetry {
  id                 String   @id @default(uuid())
  robotId            String
  batteryLevel       Int
  batteryVoltage     Float?
  batteryTemperature Float?
  cpuUsage           Float
  memoryUsage        Float
  diskUsage          Float?
  temperature        Float
  humidity           Float?
  speed              Float?
  sensors            String   @default("{}") // JSON: Record<string, number | boolean | string>
  errors             String   @default("[]") // JSON: string[]
  warnings           String   @default("[]") // JSON: string[]
  timestamp          DateTime @default(now())

  robot Robot @relation(fields: [robotId], references: [id], onDelete: Cascade)

  @@index([robotId, timestamp])
  @@index([timestamp])
}

model RobotCommand {
  id           String    @id @default(uuid())
  robotId      String
  type         String // CommandType enum as string
  payload      String    @default("{}") // JSON
  status       String    @default("pending") // CommandStatus enum as string
  priority     String    @default("normal") // CommandPriority enum as string
  result       String?   // JSON
  errorMessage String?
  createdAt    DateTime  @default(now())
  startedAt    DateTime?
  completedAt  DateTime?

  robot Robot @relation(fields: [robotId], references: [id], onDelete: Cascade)

  @@index([robotId, status])
  @@index([createdAt])
}

model RobotEndpoints {
  id          String   @id @default(uuid())
  robotId     String   @unique
  robot       String // endpoint path
  command     String // endpoint path
  telemetry   String // endpoint path
  telemetryWs String // WebSocket URL
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  robotRef Robot @relation(fields: [robotId], references: [id], onDelete: Cascade)
}

// ============================================================================
// A2A CONVERSATION ENTITIES
// ============================================================================

model Conversation {
  id        String    @id @default(uuid())
  name      String
  isActive  Boolean   @default(true)
  robotId   String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Soft delete support
  deletedAt DateTime?

  // Relations
  robot    Robot?    @relation(fields: [robotId], references: [id], onDelete: SetNull)
  messages Message[]
  tasks    Task[]

  @@index([robotId])
  @@index([isActive])
  @@index([updatedAt])
}

model Message {
  id             String   @id @default(uuid())
  role           String // MessageRole: 'user' | 'agent'
  parts          String // JSON: A2APart[]
  conversationId String?
  taskId         String?
  metadata       String?  // JSON: Record<string, unknown>
  timestamp      DateTime @default(now())

  // Relations
  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  task         Task?         @relation(fields: [taskId], references: [id], onDelete: SetNull)

  @@index([conversationId, timestamp])
  @@index([taskId])
}

model Task {
  id              String   @id @default(uuid())
  conversationId  String?
  state           String   @default("submitted") // TaskState enum as string
  statusMessage   String?  // JSON: A2AMessage
  statusTimestamp DateTime @default(now())
  artifacts       String   @default("[]") // JSON: A2AArtifact[]
  history         String   @default("[]") // JSON: A2AMessage[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  messages     Message[]

  @@index([conversationId])
  @@index([state])
  @@index([updatedAt])
}

// ============================================================================
// AGENT ENTITIES
// ============================================================================

model AgentCard {
  id                 String   @id @default(uuid())
  name               String   @unique
  description        String
  url                String
  version            String?
  documentationUrl   String?
  provider           String?  // JSON: { organization, url? }
  capabilities       String?  // JSON: { streaming?, pushNotifications?, stateTransitionHistory? }
  authentication     String?  // JSON: { schemes[], credentials? }
  defaultInputModes  String   @default("[]") // JSON: string[]
  defaultOutputModes String   @default("[]") // JSON: string[]
  skills             String   @default("[]") // JSON: A2ASkill[]
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Robot association (for robot agents)
  robotId String? @unique
  robot   Robot?  @relation(fields: [robotId], references: [id], onDelete: Cascade)

  @@index([name])
}

// ============================================================================
// ALERTS
// ============================================================================

model Alert {
  id             String    @id @default(uuid())
  severity       String // AlertSeverity: 'critical' | 'error' | 'warning' | 'info'
  title          String
  message        String
  source         String // AlertSource: 'robot' | 'task' | 'system' | 'user'
  sourceId       String? // ID of the source entity (robotId, taskId, etc.)
  acknowledged   Boolean   @default(false)
  acknowledgedAt DateTime?
  acknowledgedBy String? // User ID who acknowledged
  dismissable    Boolean   @default(true)
  autoDismissMs  Int? // Auto-dismiss after ms (null = never)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Optional relation to robot if source is robot
  robot Robot? @relation(fields: [sourceId], references: [id], onDelete: SetNull)

  @@index([severity])
  @@index([source])
  @@index([sourceId])
  @@index([acknowledged])
  @@index([createdAt])
}

// ============================================================================
// ZONES
// ============================================================================

model Zone {
  id          String   @id @default(uuid())
  name        String
  floor       String
  type        String // ZoneType: 'operational' | 'restricted' | 'charging' | 'maintenance'
  bounds      String // JSON: { x, y, width, height }
  color       String?
  description String?
  metadata    String? // JSON: Record<string, unknown>
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([name, floor])
  @@index([floor])
  @@index([type])
}

// ============================================================================
// EVENT LOG
// ============================================================================

model Event {
  id        String   @id @default(uuid())
  actor     String // 'user' | 'agent' | 'system'
  content   String // JSON: A2AMessage
  timestamp DateTime @default(now())

  @@index([timestamp])
  @@index([actor])
}

// ============================================================================
// USER AUTHENTICATION
// ============================================================================

model User {
  id                   String    @id @default(uuid())
  email                String    @unique
  passwordHash         String
  name                 String
  role                 String    @default("viewer") // UserRole: 'admin' | 'operator' | 'viewer'
  avatar               String?
  tenantId             String?
  isActive             Boolean   @default(true)
  passwordResetToken   String?
  passwordResetExpires DateTime?
  lastLoginAt          DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relations
  refreshTokens RefreshToken[]

  @@index([email])
  @@index([role])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([token])
}

// ============================================================================
// COMMAND INTERPRETATION
// ============================================================================

model CommandInterpretation {
  id                    String    @id @default(uuid())
  robotId               String
  originalText          String
  commandType           String // CommandType enum as string
  parameters            String    @default("{}") // JSON: CommandParameters
  confidence            Float
  safetyClassification  String // 'safe' | 'caution' | 'dangerous'
  warnings              String    @default("[]") // JSON: string[]
  suggestedAlternatives String    @default("[]") // JSON: string[]
  status                String    @default("interpreted") // CommandHistoryStatus
  executedCommandId     String? // Link to RobotCommand if executed
  createdAt             DateTime  @default(now())
  executedAt            DateTime?

  @@index([robotId])
  @@index([createdAt])
  @@index([status])
}

// ============================================================================
// PROCESS WORKFLOW MANAGEMENT
// ============================================================================

model ProcessDefinition {
  id                       String   @id @default(uuid())
  name                     String
  description              String?
  version                  Int      @default(1)
  status                   String   @default("draft") // ProcessDefinitionStatus: 'draft' | 'ready' | 'archived'
  stepTemplates            String   @default("[]") // JSON: StepTemplate[]
  requiredCapabilities     String   @default("[]") // JSON: string[]
  estimatedDurationMinutes Int?
  maxConcurrentInstances   Int?
  tags                     String   @default("[]") // JSON: string[]
  createdBy                String
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  // Relations
  instances ProcessInstance[]

  @@index([name])
  @@index([status])
  @@index([createdBy])
}

model ProcessInstance {
  id                    String    @id @default(uuid())
  processDefinitionId   String
  processName           String
  description           String?
  status                String    @default("pending") // ProcessInstanceStatus
  priority              String    @default("normal") // Priority: 'low' | 'normal' | 'high' | 'critical'
  currentStepIndex      Int       @default(0)
  progress              Int       @default(0) // 0-100
  preferredRobotIds     String    @default("[]") // JSON: string[]
  assignedRobotIds      String    @default("[]") // JSON: string[]
  scheduledAt           DateTime?
  startedAt             DateTime?
  completedAt           DateTime?
  estimatedCompletionAt DateTime?
  inputData             String?   // JSON: Record<string, unknown>
  outputData            String?   // JSON: Record<string, unknown>
  errorMessage          String?
  createdBy             String
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  processDefinition ProcessDefinition @relation(fields: [processDefinitionId], references: [id], onDelete: Cascade)
  steps             StepInstance[]
  robotTasks        RobotTask[]

  @@index([processDefinitionId])
  @@index([status])
  @@index([priority])
  @@index([createdBy])
  @@index([createdAt])
}

model StepInstance {
  id                String    @id @default(uuid())
  processInstanceId String
  stepTemplateId    String
  order             Int
  name              String
  description       String?
  actionType        String // StepActionType
  actionConfig      String    @default("{}") // JSON: Record<string, unknown>
  status            String    @default("pending") // StepInstanceStatus
  assignedRobotId   String?
  startedAt         DateTime?
  completedAt       DateTime?
  result            String?   // JSON: StepResult
  error             String?
  retryCount        Int       @default(0)
  maxRetries        Int       @default(3)
  failedRobotIds    String    @default("[]") // JSON: string[] - robots that failed this step
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  processInstance ProcessInstance @relation(fields: [processInstanceId], references: [id], onDelete: Cascade)
  robotTask       RobotTask?

  @@index([processInstanceId])
  @@index([status])
  @@index([order])
}

// ============================================================================
// ROBOT TASK (Work Item for Robots)
// ============================================================================

model RobotTask {
  id                String    @id @default(uuid())
  processInstanceId String?
  stepInstanceId    String?   @unique
  source            String    @default("manual") // RobotTaskSource: 'process' | 'command' | 'manual'
  robotId           String?   // Optional until assigned by TaskDistributor
  priority          String    @default("normal") // Priority
  status            String    @default("pending") // RobotTaskStatus
  actionType        String // StepActionType
  actionConfig      String    @default("{}") // JSON: Record<string, unknown>
  instruction       String
  a2aTaskId         String?
  a2aContextId      String?
  assignedAt        DateTime?
  startedAt         DateTime?
  completedAt       DateTime?
  timeoutMs         Int?
  result            String?   // JSON: RobotTaskResult
  error             String?
  retryCount        Int       @default(0)
  maxRetries        Int       @default(3)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  robot           Robot?           @relation(fields: [robotId], references: [id], onDelete: Cascade)
  processInstance ProcessInstance? @relation(fields: [processInstanceId], references: [id], onDelete: SetNull)
  stepInstance    StepInstance?    @relation(fields: [stepInstanceId], references: [id], onDelete: SetNull)

  @@index([robotId])
  @@index([processInstanceId])
  @@index([status])
  @@index([priority])
  @@index([source])
  @@index([createdAt])
}

// ============================================================================
// AI EXPLAINABILITY (EU AI Act Art. 13, Art. 50)
// ============================================================================

model Decision {
  id           String   @id @default(uuid())
  decisionType String // 'command_interpretation' | 'task_execution' | 'safety_action'
  entityId     String // Foreign key to CommandInterpretation, RobotTask, etc.
  robotId      String

  inputFactors  String // JSON: DecisionInputFactors
  reasoning     String // JSON: string[] - step-by-step reasoning
  modelUsed     String // e.g., 'gemini-2.5-flash'
  confidence    Float
  alternatives  String // JSON: AlternativeConsidered[]
  safetyFactors String // JSON: DecisionSafetyFactors

  createdAt DateTime @default(now())

  // Relation to compliance logs
  complianceLogs ComplianceLog[]

  @@index([entityId])
  @@index([robotId])
  @@index([decisionType])
  @@index([createdAt])
}

// ============================================================================
// COMPLIANCE LOGGING (EU AI Act Art. 12, GDPR Art. 30, Machinery Regulation)
// ============================================================================

model ComplianceLog {
  id         String @id @default(uuid())
  sessionId  String // Session identifier for grouping related logs
  robotId    String // Robot that generated the event
  operatorId String? // User/operator ID (null for autonomous operations)

  // Event classification
  eventType String // 'ai_decision' | 'safety_action' | 'command_execution' | 'system_event' | 'access_audit'
  severity  String @default("info") // 'debug' | 'info' | 'warning' | 'error' | 'critical'

  // Encrypted payload (AES-256-GCM)
  payloadEncrypted String // Base64-encoded encrypted JSON payload
  payloadIv        String // Base64-encoded initialization vector
  payloadHash      String // SHA-256 hash of unencrypted payload for verification

  // ML model tracking (for AI decisions)
  modelVersion String? // e.g., 'gemini-2.0-flash'
  modelHash    String? // Hash of model configuration

  // Input-output matching (for traceability)
  inputHash  String? // SHA-256 hash of input data
  outputHash String? // SHA-256 hash of output data

  // Hash chain for tamper evidence
  previousHash String // Hash of previous log entry (empty string for first entry)
  currentHash  String // SHA-256(previousHash + timestamp + payloadHash + eventType)

  // Link to AI Explainability system
  decisionId String?
  decision   Decision? @relation(fields: [decisionId], references: [id], onDelete: SetNull)

  // Timestamps
  timestamp DateTime @default(now())

  // Immutability flag - prevents updates/deletes at application level
  immutable Boolean @default(true)

  // Retention management (Task 24)
  retentionExpiresAt DateTime? // When this log can be deleted
  legalHoldId        String?   // If under legal hold, references LegalHold.id

  // Relations
  accessLogs ComplianceLogAccess[]

  @@index([sessionId])
  @@index([retentionExpiresAt])
  @@index([robotId])
  @@index([operatorId])
  @@index([eventType])
  @@index([severity])
  @@index([timestamp])
  @@index([decisionId])
  @@index([currentHash])
}

model ComplianceLogAccess {
  id        String   @id @default(uuid())
  logId     String
  userId    String? // User who accessed (null for system access)
  accessType String // 'view' | 'export' | 'verify' | 'audit'
  ipAddress String?
  userAgent String?
  timestamp DateTime @default(now())

  // Relations
  log ComplianceLog @relation(fields: [logId], references: [id], onDelete: Cascade)

  @@index([logId])
  @@index([userId])
  @@index([timestamp])
}

// ============================================================================
// RETENTION & AUDIT TRAIL MANAGEMENT (EU AI Act Art. 12, GDPR Art. 30)
// ============================================================================

model RetentionPolicy {
  id            String   @id @default(uuid())
  eventType     String   @unique // 'ai_decision' | 'safety_action' | 'command_execution' | 'system_event' | 'access_audit'
  retentionDays Int      // Days to retain logs (e.g., 3650 = 10 years)
  description   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([eventType])
}

model LegalHold {
  id        String    @id @default(uuid())
  name      String
  reason    String
  createdBy String    // User ID who created the hold
  startDate DateTime  @default(now())
  endDate   DateTime?
  isActive  Boolean   @default(true)
  logIds    String[]  // Array of ComplianceLog IDs under hold
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([isActive])
  @@index([createdBy])
}

// GDPR Article 30 - Records of Processing Activities
model RopaEntry {
  id                    String   @id @default(uuid())
  processingActivity    String   // Name of the processing activity
  purpose               String   // Purpose of processing
  dataCategories        String[] // Types of personal data processed
  dataSubjects          String[] // Categories of data subjects
  recipients            String[] // Recipients of the data
  thirdCountryTransfers String?  // International transfers info
  retentionPeriod       String   // How long data is retained
  securityMeasures      String[] // Technical/organizational security measures
  legalBasis            String   // GDPR legal basis (consent, contract, legal obligation, etc.)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([processingActivity])
}

// AI Provider Documentation (EU AI Act transparency requirements)
model ProviderDocumentation {
  id           String    @id @default(uuid())
  providerName String    // e.g., 'Google Gemini', 'OpenAI'
  modelVersion String    // e.g., 'gemini-2.0-flash'
  documentType String    // 'technical_doc' | 'risk_assessment' | 'conformity_declaration' | 'user_manual'
  documentUrl  String?   // URL to external documentation
  content      String    // Documentation content or summary
  validFrom    DateTime  // When this documentation became valid
  validTo      DateTime? // When this documentation expires (null = still valid)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([providerName])
  @@index([modelVersion])
  @@index([documentType])
}
